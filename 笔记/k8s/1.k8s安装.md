
```text
机器
    192.168.118.3
    192.168.118.4
    192.168.118.5
    192.168.118.6
    192.168.118.7

环境配置
    1. 设置主机名与时区  
        timedatectl set-timezone Asia/Shanghai #  都要执行
        hostnamectl set-hostname master1       #  118.3
        hostnamectl set-hostname master2       #  118.4
        hostnamectl set-hostname master3       #  118.5
        hostnamectl set-hostname node1         #  118.6
        hostnamectl set-hostname node2         #  118.7

    2. 添加hosts网络主机配置,方便寻找主机
        vi /etc/hosts
            192.168.118.3  master1 
            192.168.118.4  master2 
            192.168.118.5  master3 
            192.168.118.6  node1   
            192.168.118.7  node2   
            
            
    3. 关闭防火墙，这一步操作是为了防止在学习阶段由于防火墙造成的各种网络问题，生产环境跳过这一步，
        systemctl stop firewalld
        systemctl disable firewalld
    
    3.1 # 关闭selinux
        sed -i 's/enforcing/disabled/' /etc/selinux/config  # 永久
        setenforce 0  # 临时


    4. 关闭交换区
        swapoff -a
        vi /etc/fstab
        #swap一行注释
        #/dev/mapper/centos-swap swap swap defaults 0 0
       

       
       
       
```

#### 5.#允许 iptables 检查桥接流量
```text
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
br_netfilter
EOF

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
EOF
sudo sysctl --system

```


#### 修改 docker源：
```text
yum install -y yum-utils
yum-config-manager \
--add-repo \
http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
yum makecache fast
```

#### 修改 kubernetes源：
```text
cat > /etc/yum.repos.d/kubernetes.repo << EOF
[kubernetes]
name=Kubernetes
baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=0
repo_gpgcheck=0
gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
EOF
```

#### 安装docker
```text
sudo yum install -y yum-utils
sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo

yum install -y docker-ce-20.10.7 docker-ce-cli-20.10.7  containerd.io-1.4.6

service docker start
systemctl enable docker

vi /etc/docker/daemon.json
{
"registry-mirrors": ["http://hub-mirror.c.163.com","https://registry.docker-cn.com","https://kxv08zer.mirror.aliyuncs.com"]
}

systemctl daemon-reload
systemctl restart docker
```




#### 6.安装kubeadm
```text
yum install -y kubelet-1.23.16-0 kubeadm-1.23.16-0 kubectl-1.23.16-0 --disableexcludes=kubernetes
sudo systemctl enable --now kubelet
```

#### 拉取docker 镜像
```text
#查看初始化所需的镜像
kubeadm config images list

#编辑文件
pull_images.sh

#!/bin/bash
images=(
registry.aliyuncs.com/google_containers/kube-apiserver:v1.23.17
registry.aliyuncs.com/google_containers/kube-controller-manager:v1.23.17
registry.aliyuncs.com/google_containers/kube-scheduler:v1.23.17
registry.aliyuncs.com/google_containers/kube-proxy:v1.23.17
registry.aliyuncs.com/google_containers/pause:3.6
registry.aliyuncs.com/google_containers/etcd:3.5.6-0
registry.aliyuncs.com/google_containers/coredns:v1.8.6
)
for pullimageName in ${images[@]} ; do
docker pull $pullimageName
done

# 执行脚本拉取镜像
sh pull_images.sh


```


#### kubeadm init        
```text
===========================================================================================================
初始化之后，会输出一个join命令，先复制出来，node节点加入master会使用。
--image-repository registry.aliyuncs.com/google_containers 镜像仓库，离线安装需要把相关镜像先拉取下来
--apiserver-advertise-address 集群通告地址
--image-repository 由于默认拉取镜像地址k8s.gcr.io国内无法访问，这里指定阿里云镜像仓库地址
--kubernetes-version K8s版本，与上面安装的一致
--service-cidr 集群内部虚拟网络，Pod统一访问入口
--pod-network-cidr Pod网络，与下面部署的CNI网络组件yaml中保持一致
===========================================================================================================


kubeadm init \
  --apiserver-advertise-address=192.168.118.18 \
  --image-repository registry.aliyuncs.com/google_containers \
  --kubernetes-version v1.23.0 \
  --service-cidr=10.96.0.0/12 \
  --pod-network-cidr=10.244.0.0/16 \
  --ignore-preflight-errors=all


mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config


```



####  工作节点加入集群
```text

#默认token有效期为24小时，当过期之后，该token就不可用了。这时就需要重新创建token，可以直接使用命令快捷生成：
kubeadm token create --print-join-command


kubeadm join 192.168.118.18:6443 --token o7zvmu.683tkg2wpuyau0k8 \
    --discovery-token-ca-cert-hash sha256:b287cec0ee3d2d02ac4e2ce91954e8e41f66f1db7b1993b19d6773ae77295c9a

```



#### 查看节点为
```text
# kubectl get nodes

===============================================================
NAME     STATUS     ROLES                  AGE     VERSION
master   NotReady   control-plane,master   4m18s   v1.23.16
node1    NotReady   <none>                 3m6s    v1.23.16
node2    NotReady   <none>                 2m53s   v1.23.16
===============================================================
注：由于网络插件还没有部署，还没有准备就绪 NotReady，继续操作。
 
```

#### 部署容器网络 （master执行）
```text
#查看pod 网段
cat /etc/kubernetes/manifests/kube-controller-manager.yaml | grep cluster-cidr=

#把calico.yaml里pod所在网段改成kubeadm init时选项--pod-network-cidr所指定的网段，
########################### 修改calico.yaml文件

# 修改网段
- name: CALICO_IPV4POOL_CIDR      #此处
  value: "10.244.0.0/16"	

# 修改网卡
  - name: IP_AUTODETECTION_METHOD
    value: "interface=ens33"

```

#### 下载镜像
```text
pull_calico_images.sh

#!/bin/bash
images=(
docker.io/calico/cni:v3.22.1
docker.io/calico/pod2daemon-flexvol:v3.22.1
docker.io/calico/node:v3.22.1
docker.io/calico/kube-controllers:v3.22.1
)
for pullimageName in ${images[@]} ; do
docker pull $pullimageName
done

```



#### 下载dashboard镜像
```text
pull_calico_dashboard.sh

#!/bin/bash
images=(
kubernetesui/dashboard:v2.5.1
kubernetesui/metrics-scraper:v1.0.7
)
for pullimageName in ${images[@]} ; do
docker pull $pullimageName
done
```






yum remove -y kubelet kubeadm kubectl



